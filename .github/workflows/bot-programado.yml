name: Ejecutar Bot AutomÃ¡ticamente

on:
  schedule:
    # Corre cada 3 horas desde las 8:00 AM hasta las 5:00 PM (Guatemala, UTC-6)
    - cron: '0 14 * * *'  # 8:00 Guatemala
    - cron: '0 17 * * *'  # 11:00 Guatemala
    - cron: '0 20 * * *'  # 2:00 Guatemala
    - cron: '0 23 * * *'  # 5:00 Guatemala
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Timeout global de 2 horas
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
      FB_COOKIES_JSON: ${{ secrets.FB_COOKIES_JSON }}
      DB_PATH: upload-artifact/anuncios.db
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.cache/ms-playwright

    steps:
      # 1ï¸âƒ£ Clonar main
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2ï¸âƒ£ Clonar el branch 'data'
      - name: Checkout branch de datos
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: data
          token: ${{ secrets.PAT_PUSH }}
          path: data
          fetch-depth: 1

      # 3ï¸âƒ£ Restaurar o iniciar base
      - name: Preparar DB histÃ³rica
        run: |
          mkdir -p upload-artifact
          if [ -f data/anuncios.db ]; then
            cp data/anuncios.db "${{ env.DB_PATH }}"
            echo "âœ… Base histÃ³rica cargada ($(stat -c%s data/anuncios.db) bytes)"
          else
            echo "âš ï¸ No hay base previa. Se inicia nueva"
            touch "${{ env.DB_PATH }}"
          fi

      # 4ï¸âƒ£ Setup Python con cache
      - name: Setup Python con cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # 5ï¸âƒ£ Instalar dependencias Python PRIMERO
      - name: Instalar dependencias Python
        run: |
          python -m pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
          echo "âœ… Dependencias Python instaladas"

      # 6ï¸âƒ£ Cache de Playwright browsers (DESPUÃ‰S de instalar playwright)
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-chromium-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            playwright-chromium-${{ runner.os }}-

      # 7ï¸âƒ£ Instalar Playwright Chromium
      - name: Instalar Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ’¡ Instalando Chromium de Playwright..."
          python -m playwright install chromium --with-deps
          echo "âœ… Chromium instalado correctamente"

      # 8ï¸âƒ£ Verificar instalaciÃ³n de Chromium
      - name: Verificar instalaciÃ³n de Chromium
        run: |
          echo "ğŸ” Verificando Chromium..."
          if [ -d "$PLAYWRIGHT_BROWSERS_PATH/chromium-"* ]; then
            echo "âœ… Chromium encontrado en cachÃ©"
            ls -lh "$PLAYWRIGHT_BROWSERS_PATH/chromium-"* | head -5
          else
            echo "âŒ Chromium no encontrado, instalando..."
            python -m playwright install chromium --with-deps
          fi

      # 9ï¸âƒ£ Instalar SQLite3
      - name: Instalar SQLite3
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq sqlite3
          sqlite3 --version

      # ğŸ”Ÿ Inicializar estructura de la base
      - name: Inicializar estructura de la base
        run: |
          sqlite3 "${{ env.DB_PATH }}" "
            CREATE TABLE IF NOT EXISTS anuncios (
              link TEXT PRIMARY KEY,
              modelo TEXT,
              anio INTEGER,
              precio INTEGER,
              km TEXT,
              fecha_scrape DATE,
              roi REAL,
              score INTEGER
            );
          "
          
          # Agregar columnas adicionales si no existen
          for col in updated_at relevante confianza_precio muestra_precio; do
            if ! sqlite3 "${{ env.DB_PATH }}" "PRAGMA table_info(anuncios);" | grep -q "^[0-9]*|$col|"; then
              echo "âœ… Agregando columna $col"
              case $col in
                updated_at|fecha_scrape)
                  sqlite3 "${{ env.DB_PATH }}" "ALTER TABLE anuncios ADD COLUMN $col DATE;"
                  ;;
                relevante)
                  sqlite3 "${{ env.DB_PATH }}" "ALTER TABLE anuncios ADD COLUMN $col BOOLEAN DEFAULT 0;"
                  ;;
                confianza_precio|muestra_precio)
                  sqlite3 "${{ env.DB_PATH }}" "ALTER TABLE anuncios ADD COLUMN $col INTEGER;"
                  ;;
              esac
            else
              echo "â„¹ï¸ Columna $col ya existe"
            fi
          done
          
          echo "âœ… Estructura de DB verificada"

      # 1ï¸âƒ£1ï¸âƒ£ Contar anuncios antes del run
      - name: Contar anuncios antes del run
        id: db_prev
        run: |
          echo "ğŸ•’ Contando anuncios previos..."
          BEFORE=$(sqlite3 "${{ env.DB_PATH }}" 'SELECT COUNT(*) FROM anuncios;')
          echo "before=$BEFORE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Total de anuncios previos: $BEFORE"

      # 1ï¸âƒ£2ï¸âƒ£ Volumen previo por modelo
      - name: Volumen previo en DB
        run: |
          echo "ğŸ“Š Top 10 modelos en DB:"
          sqlite3 "${{ env.DB_PATH }}" \
            "SELECT modelo, COUNT(*) as cnt FROM anuncios GROUP BY modelo ORDER BY cnt DESC LIMIT 10;" \
            || echo "âš ï¸ No hay datos previos"

      # 1ï¸âƒ£3ï¸âƒ£ Ejecutar el bot con Telegram (CON TIMEOUT)
      - name: Ejecutar bot con Telegram
        id: run_bot
        timeout-minutes: 90
        run: |
          echo "ğŸ¤– Iniciando bot..."
          python bot_telegram_marketplace.py 2>&1 | tee resultado.log
          
          # Extraer mÃ©tricas del log
          NUEVOS=$(grep -oP 'NUEVOS=\K\d+' resultado.log || echo "0")
          ACTUALIZADOS=$(grep -oP 'ACTUALIZADOS=\K\d+' resultado.log || echo "0")
          
          echo "nuevos=$NUEVOS" >> $GITHUB_OUTPUT
          echo "actualizados=$ACTUALIZADOS" >> $GITHUB_OUTPUT
          echo "âœ… Bot ejecutado: $NUEVOS nuevos, $ACTUALIZADOS actualizados"

      # 1ï¸âƒ£4ï¸âƒ£ Verificar integridad de DB
      - name: Verificar integridad de DB
        run: |
          echo "ğŸ” Verificando integridad de la base..."
          sqlite3 "${{ env.DB_PATH }}" "PRAGMA integrity_check;" || {
            echo "âŒ Base de datos corrupta"
            exit 1
          }
          echo "âœ… Base de datos Ã­ntegra"

      # 1ï¸âƒ£5ï¸âƒ£ Guardar nueva versiÃ³n de la DB
      - name: Copiar DB al branch data
        run: |
          cp "${{ env.DB_PATH }}" data/anuncios.db
          echo "âœ… DB copiada ($(stat -c%s data/anuncios.db) bytes)"

      # 1ï¸âƒ£6ï¸âƒ£ Commit & push DB actualizada
      - name: Commit & push DB actualizada
        env:
          PAT_PUSH: ${{ secrets.PAT_PUSH }}
        run: |
          cd data
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${PAT_PUSH}@github.com/${{ github.repository }}
          git add anuncios.db
          
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "ğŸ”„ DB actualizada: ${{ steps.run_bot.outputs.nuevos }} nuevos, ${{ steps.run_bot.outputs.actualizados }} actualizados [$TIMESTAMP]"
            git push origin data
            echo "âœ… DB pusheada exitosamente"
          else
            echo "ğŸ“ Sin cambios en DB, se omite push"
          fi

      # 1ï¸âƒ£7ï¸âƒ£ Resumen final del run
      - name: Resumen final del run
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE EJECUCIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          BEFORE="${{ steps.db_prev.outputs.before }}"
          FINAL=$(sqlite3 "${{ env.DB_PATH }}" "SELECT COUNT(*) FROM anuncios;" || echo "ERROR")
          NUEVOS="${{ steps.run_bot.outputs.nuevos }}"
          ACTUALIZADOS="${{ steps.run_bot.outputs.actualizados }}"
          
          echo "ğŸ“¦ Anuncios antes:     $BEFORE"
          echo "ğŸ“¦ Anuncios despuÃ©s:   $FINAL"
          echo "â• Nuevos insertados:  $NUEVOS"
          echo "ğŸ”„ Actualizados:       $ACTUALIZADOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$FINAL" != "ERROR" ]; then
            echo ""
            echo "ğŸ” Ãšltimo anuncio registrado:"
            sqlite3 "${{ env.DB_PATH }}" \
              "SELECT modelo, precio, anio, fecha_scrape FROM anuncios ORDER BY rowid DESC LIMIT 1;" \
              || echo "âš ï¸ No se pudo consultar"
            
            echo ""
            echo "ğŸ“ˆ Top 5 modelos:"
            sqlite3 "${{ env.DB_PATH }}" \
              "SELECT modelo, COUNT(*) as cnt FROM anuncios GROUP BY modelo ORDER BY cnt DESC LIMIT 5;" \
              || echo "âš ï¸ No se pudo consultar"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # 1ï¸âƒ£8ï¸âƒ£ Subir logs en caso de error
      - name: Subir logs si hay error
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-error-${{ github.run_number }}
          path: |
            resultado.log
            upload-artifact/anuncios.db
          retention-days: 7
