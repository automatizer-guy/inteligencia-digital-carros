name: Ejecutar Bot Autom√°ticamente

on:
  schedule:
    # Corre cada 2 horas entre las 8 AM y 6 PM (UTC-6 Guatemala)
    - cron: '0 14-23/2 * * *'
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      BOT_TOKEN:        ${{ secrets.BOT_TOKEN }}
      CHAT_ID:          ${{ secrets.CHAT_ID }}
      FB_COOKIES_JSON:  ${{ secrets.FB_COOKIES_JSON }}
      DB_PATH:          upload-artifact/anuncios.db

    steps:
      # 1) Checkout del c√≥digo principal (m√≥dulo scraper, utils, etc.)
      - name: Checkout main
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) Checkout del branch 'data' que contiene la DB hist√≥rica
      - name: Checkout branch de datos
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          token:      ${{ secrets.GITHUB_TOKEN }}
          ref:        data
          path:       data

      # 3) Traer la DB hist√≥rica a upload-artifact/
      - name: Preparar DB hist√≥rica
        run: |
          mkdir -p upload-artifact
          if [ -f data/anuncios.db ]; then
            cp data/anuncios.db "${{ env.DB_PATH }}"
            echo "‚úÖ Base hist√≥rica cargada: data/anuncios.db"
          else
            echo "‚ö†Ô∏è No se encontr√≥ base hist√≥rica. Se inicializar√° una nueva."
            touch "${{ env.DB_PATH }}"
          fi

      # 4) Mostrar conteo previo (opcional)
      - name: Volumen previo en DB
        run: |
          sudo apt-get update && sudo apt-get install -y sqlite3
          echo "üìä Anuncios por modelo (previo):"
          sqlite3 "${{ env.DB_PATH }}" \
            "SELECT modelo, COUNT(*) FROM anuncios GROUP BY modelo ORDER BY COUNT(*) DESC;"

      # 5) Instalar dependencias y navegadores
      - name: Instalar dependencias Python y Playwright
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          npx playwright install --with-deps

      # 6) Ejecutar el bot
      - name: Ejecutar bot con Telegram
        run: python bot_telegram_marketplace.py

      # 7) Copiar DB actualizada al branch data
      - name: Guardar DB actualizada en data/
        run: |
          cp "${{ env.DB_PATH }}" data/anuncios.db

      # 8) Commit & push de la DB al branch data
      - name: Commit & push DB actualizada
        run: |
          cd data
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add anuncios.db
          if ! git diff --cached --quiet; then
            git commit -m "üîÑ Actualiza DB (run #${{ github.run_number }})"
            git push origin data
          else
            echo "üëÄ Sin cambios en la DB, nada que commitear."
          fi

      # 9) Resumen final del run
      - name: Resumen final del run
        run: |
          sudo apt-get update && sudo apt-get install -y sqlite3
          echo "‚úÖ Bot ejecutado con √©xito"
          echo "üì¶ Total de anuncios registrados:"
          sqlite3 "${{ env.DB_PATH }}" "SELECT COUNT(*) FROM anuncios;"
          echo "üîç √öltimo anuncio registrado:"
          sqlite3 "${{ env.DB_PATH }}" \
            "SELECT link, fecha_scrape \
             FROM anuncios \
             ORDER BY fecha_scrape DESC, rowid DESC \
             LIMIT 1;"
